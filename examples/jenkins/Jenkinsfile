properties([
  parameters([
    [
      $class: 'CascadeChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'Account',
      description: 'Select the account',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [],
          sandbox: true,
          script: 'return ["ERROR: Failed to fetch accounts"]'
        ],
        script: [
          classpath: [],
          sandbox: true,
          script: '''
            import groovy.json.JsonSlurper

            try {
                def url = new URL('https://toaster.altuhov.su/api/dimension/demo-org/account?workspace=master&fallbacktomaster=true&needdimdata=false')
                def connection = url.openConnection()
                connection.setRequestProperty('Authorization', 'Basic NjYyY2FiN2M1ZTExNjgxOTczOGIwMWZlOnN1cGVydG9hc3Rlcg==')
                connection.requestMethod = 'GET'
                
                def response = connection.content.text
                def result = new JsonSlurper().parseText(response)
                
                if (result.Dimensions) {
                    return result.Dimensions.collect { it.DimValue }.unique()
                } else {
                    return ["No accounts found"]
                }
            } catch (Exception e) {
                return ["Error: ${e.message}"]
            }
          '''
        ]
      ]
    ],
    [
      $class: 'CascadeChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'DataCenter',
      description: 'Select the Data Center',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [],
          sandbox: true,
          script: 'return ["ERROR: Failed to fetch data centers"]'
        ],
        script: [
          classpath: [],
          sandbox: true,
          script: '''
            import groovy.json.JsonSlurper

            try {
                def url = new URL('https://toaster.altuhov.su/api/dimension/demo-org/datacenter?workspace=master&fallbacktomaster=true&needdimdata=false')
                def connection = url.openConnection()
                connection.setRequestProperty('Authorization', 'Basic NjYyY2FiN2M1ZTExNjgxOTczOGIwMWZlOnN1cGVydG9hc3Rlcg==')
                connection.requestMethod = 'GET'
                
                def response = connection.content.text
                def result = new JsonSlurper().parseText(response)
                
                if (result.Dimensions) {
                    return result.Dimensions.collect { it.DimValue }.unique()
                } else {
                    return ["No accounts found"]
                }
            } catch (Exception e) {
                return ["Error: ${e.message}"]
            }
          '''
        ]
      ]
    ]
  ])
])

pipeline {
  agent any
  stages {
    stage('Build') {
      steps {
        echo "Selected account: ${params.Account}"
        echo "Selected data center: ${params.DataCenter}"
      }
    }
    stage('Tofugu') {
      steps {
        git 'https://github.com/alt-dima/tofugu.git'
        sh 'wget https://github.com/alt-dima/tofugu/releases/download/v0.5.0/tofugu_0.5.0_linux_arm64.tar.gz'
        sh 'tar -xvf tofugu_0.5.0_linux_arm64.tar.gz'
        sh './tofugu'
        sh 'ls -la'
      }
    }
  }
}
